# 🎨 الرسم التخطيطي البصري لسيناريو البصمة

## السيناريو الكامل في صورة واحدة

```
╔═══════════════════════════════════════════════════════════════════════════════╗
║                          🚀 بداية التطبيق                                     ║
╚═══════════════════════════════════════════════════════════════════════════════╝
                                      │
                                      ↓
                    ┌─────────────────────────────────┐
                    │      صفحة الدخول (Login)        │
                    │    ┌─────────────────────┐     │
                    │    │   Jeel ERP  ⋮       │     │
                    │    └─────────────────────┘     │
                    │                                │
                    │    Email: [____________]       │
                    │    Password: [________]  👁    │
                    │                                │
                    │    [     Log in      ]         │
                    │                                │
                    │         🔵                      │
                    │        (بصمة)                  │
                    └─────────────────────────────────┘
                                      │
                    ┌─────────────────┴────────────────┐
                    │   _initialSetup() التلقائي      │
                    └─────────────────┬────────────────┘
                                      │
                ┌─────────────────────┼─────────────────────┐
                │                     │                     │
                ↓                     ↓                     ↓
         ┌──────────┐          ┌──────────┐         ┌──────────┐
         │  فحص     │          │  تحميل   │         │  فحص     │
         │ البصمة   │          │ البيانات │         │ الجلسة   │
         │ متاحة؟   │          │المحفوظة؟ │         │  نشطة؟   │
         └────┬─────┘          └────┬─────┘         └────┬─────┘
              │                     │                    │
              │                     │                    │
        ┌─────┴─────┐         ┌─────┴─────┐       ┌─────┴─────┐
        │ ✅ نعم    │         │ ✅ نعم    │       │ ✅ نعم    │
        │ ❌ لا     │         │ ❌ لا     │       │ ❌ لا     │
        └───────────┘         └───────────┘       └───────────┘
              │                     │                    │
              └──────────┬──────────┴────────────────────┘
                         │
                    ✅ الكل نعم؟
                         │
                    ┌────┴────┐
                    │   نعم   │   لا
                    ↓         ↓
              ┌─────────┐   [انتظار المستخدم]
              │ تشغيل   │
              │البصمة   │
              │تلقائياً │
              └────┬────┘
                   │
                   ↓


╔═══════════════════════════════════════════════════════════════════════════════╗
║                    🎯 السيناريو 1: المستخدم الجديد                            ║
╚═══════════════════════════════════════════════════════════════════════════════╝

    المستخدم يدخل البريد وكلمة المرور يدوياً
                   │
                   ↓
           [يضغط Log in]
                   │
                   ↓
    ┌──────────────────────────────┐
    │   SessionManager             │
    │   ↓ حفظ البريد الإلكتروني    │
    │   ↓ حفظ كلمة المرور (مشفر)   │
    │   ↓ تعيين is_logged_in=true │
    └──────────────┬───────────────┘
                   │
                   ↓
    ┌──────────────────────────────┐
    │      الانتقال إلى WebView    │
    │   shouldAutoFill = false     │
    │   (دخول عادي - بدون تعبئة)   │
    └──────────────┬───────────────┘
                   │
                   ↓
    ┌──────────────────────────────┐
    │    المستخدم يملأ الفورم      │
    │    على الموقع يدوياً         │
    └──────────────┬───────────────┘
                   │
                   ↓
              ✅ دخول ناجح
              الآن يمكنه استخدام البصمة


╔═══════════════════════════════════════════════════════════════════════════════╗
║                   🎯 السيناريو 2: دخول تلقائي بالبصمة                         ║
╚═══════════════════════════════════════════════════════════════════════════════╝

         التطبيق يفتح (مرة ثانية)
                   │
                   ↓
    ┌──────────────────────────────┐
    │  _initialSetup() تلقائياً    │
    │  ✅ البصمة متاحة             │
    │  ✅ بيانات محفوظة            │
    │  ✅ جلسة نشطة               │
    └──────────────┬───────────────┘
                   │
                   ↓
    ┌──────────────────────────────┐
    │   شاشة البصمة من النظام      │
    │                              │
    │       ┌───────────┐          │
    │       │     👆     │          │
    │       │    🔵     │          │
    │       └───────────┘          │
    │                              │
    │  "يرجى استخدام البصمة..."    │
    └──────────────┬───────────────┘
                   │
          ┌────────┴────────┐
          │                 │
          ↓                 ↓
    ┌─────────┐       ┌─────────┐
    │ ✅ نجح  │       │ ❌ فشل  │
    │التحقق   │       │التحقق   │
    └────┬────┘       └────┬────┘
         │                 │
         ↓                 ↓
  ┌──────────┐      ┌──────────┐
  │ استرجاع  │      │  رسالة:  │
  │ البيانات │      │ "فشل     │
  │من Storage│      │ التحقق"  │
  └────┬─────┘      └────┬─────┘
       │                 │
       ↓                 │
  ┌──────────┐           │
  │ ملء حقول │           │
  │الدخول في│           │
  │الشاشة    │           │
  └────┬─────┘           │
       │                 │
       ↓                 ↓
  ┌────────────────────────┐
  │  الانتقال إلى WebView  │
  │  shouldAutoFill = true │
  └───────────┬────────────┘
              │
              ↓
  ┌────────────────────────┐
  │  JavaScript Injection  │
  │  ↓ البحث عن حقل Email  │
  │  ↓ ملء Email           │
  │  ↓ البحث عن Password   │
  │  ↓ ملء Password        │
  │  ↓ الضغط على زر Login  │
  └───────────┬────────────┘
              │
              ↓
        ✅ دخول تلقائي كامل!


╔═══════════════════════════════════════════════════════════════════════════════╗
║                  🎯 السيناريو 3: استخدام زر البصمة يدوياً                    ║
╚═══════════════════════════════════════════════════════════════════════════════╝

    المستخدم في صفحة الدخول
                   │
                   ↓
        [يضغط على زر 🔵]
                   │
                   ↓
    ┌──────────────────────────────┐
    │   _handleBiometricLogin()    │
    └──────────────┬───────────────┘
                   │
          ┌────────┴────────┐
          │                 │
    [فحص الشروط]            │
          │                 │
    ✅ جلسة موجودة          │
    ✅ بصمة متاحة           │
          │                 │
          ↓                 ↓
    ┌─────────┐       ┌─────────┐
    │ عرض     │       │ رسالة   │
    │ البصمة  │       │ خطأ     │
    └────┬────┘       └─────────┘
         │
         ↓
   [نفس خطوات السيناريو 2]
         │
         ↓
   ✅ دخول عبر البصمة


╔═══════════════════════════════════════════════════════════════════════════════╗
║                         🔐 طبقات الأمان                                       ║
╚═══════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────┐
│  الطبقة 1: واجهة المستخدم (UI)                                          │
│  • Login Screen                                                         │
│  • WebView Screen                                                       │
└────────────────────────┬────────────────────────────────────────────────┘
                         │
                         ↓
┌─────────────────────────────────────────────────────────────────────────┐
│  الطبقة 2: خدمات التطبيق (Services)                                     │
│  • BiometricService  ← ← ← ← ← ← → توجيه للنظام                        │
│  • SessionManager    ← ← ← ← ← ← → توجيه للتخزين                        │
└────────────────────────┬────────────────────────────────────────────────┘
                         │
          ┌──────────────┴──────────────┐
          │                             │
          ↓                             ↓
┌──────────────────┐          ┌──────────────────┐
│  نظام التشغيل    │          │  التخزين الآمن   │
│  (Biometric)     │          │  (SecureStorage) │
│                  │          │                  │
│  🤖 Android:     │          │  🤖 Android:     │
│   BiometricAPI   │          │   Encrypted      │
│                  │          │   SharedPrefs    │
│  🍎 iOS:         │          │                  │
│   LocalAuth      │          │  🍎 iOS:         │
│   TouchID/FaceID │          │   Keychain       │
└──────────────────┘          └──────────────────┘


╔═══════════════════════════════════════════════════════════════════════════════╗
║                      📊 تدفق البيانات التفصيلي                                ║
╚═══════════════════════════════════════════════════════════════════════════════╝

┌───────────┐
│ المستخدم  │
└─────┬─────┘
      │ (إدخال بيانات)
      ↓
┌─────────────────────────┐
│  LoginScreen            │
│  _emailController       │ ─────┐
│  _passwordController    │      │
└─────────────────────────┘      │ saveLoginInfo()
      │                          │
      ↓                          ↓
┌─────────────────────────┐  ┌────────────────────┐
│  _handleLogin()         │  │  SessionManager    │
│  التحقق من البيانات     │  └─────────┬──────────┘
│  حفظ البيانات           │            │ write()
└─────────────────────────┘            ↓
      │                     ┌────────────────────────┐
      │                     │ FlutterSecureStorage   │
      │                     │ ┌────────────────────┐ │
      │                     │ │ username: "user@..." │
      │                     │ │ password: "***"    │ │
      │                     │ │ is_logged_in: true │ │
      │                     │ └────────────────────┘ │
      │                     └────────────────────────┘
      ↓
┌─────────────────────────┐
│  WebViewScreen          │
│  shouldAutoFill: false  │
└─────────────────────────┘
      │
      ↓
  [المستخدم يملأ الفورم]


───────── الدخول التالي ─────────

┌───────────┐
│ المستخدم  │ (يفتح التطبيق)
└─────┬─────┘
      │
      ↓
┌─────────────────────────┐
│  LoginScreen            │
│  initState()            │
└─────────┬───────────────┘
          │
          ↓
┌─────────────────────────┐
│  _initialSetup()        │
└─────────┬───────────────┘
          │
    ┌─────┴─────┐
    │           │
    ↓           ↓
┌─────────┐ ┌────────────┐
│Biometric│ │  Session   │
│Service  │ │  Manager   │
└────┬────┘ └─────┬──────┘
     │            │
     │ isAvailable() │ isLoggedIn()
     │            │ getUsername()
     │            │ getPassword()
     ↓            ↓
   [✅]         [✅]
     │            │
     └─────┬──────┘
           │
           ↓
┌──────────────────────┐
│ _handleBiometric     │
│ Login()              │
└──────────┬───────────┘
           │
           ↓
┌──────────────────────┐
│  System Biometric    │
│  (بصمة الجهاز)       │
└──────────┬───────────┘
           │
           ↓ [نجح]
┌──────────────────────┐
│  استرجاع البيانات    │
│  من Storage          │
└──────────┬───────────┘
           │
           ↓
┌──────────────────────┐
│  WebViewScreen       │
│  shouldAutoFill: true│
└──────────┬───────────┘
           │
           ↓
┌──────────────────────┐
│  JavaScript:         │
│  document            │
│  .querySelector()    │
│  .value = "..."      │
└──────────┬───────────┘
           │
           ↓
      ✅ دخول تلقائي


╔═══════════════════════════════════════════════════════════════════════════════╗
║                         ⚡ مخطط التوقيت الزمني                                ║
╚═══════════════════════════════════════════════════════════════════════════════╝

الزمن (بالثواني)
│
0s  ├─ فتح التطبيق
    │  └─ بدء تحميل LoginScreen
    │
0.1s├─ initState()
    │  └─ _initialSetup()
    │
0.2s├─ فحص البصمة متاحة؟
    │  └─ تحميل البيانات المحفوظة
    │
0.3s├─ فحص حالة الجلسة
    │
0.5s├─ ✅ كل الشروط متحققة
    │  └─ عرض شاشة البصمة
    │
    │  [المستخدم يضع بصمته]
    │
2.0s├─ نجح التحقق ✅
    │  └─ استرجاع البيانات
    │
2.1s├─ ملء حقول الدخول
    │
2.2s├─ الانتقال إلى WebView
    │  └─ بدء تحميل الموقع
    │
3.0s├─ onPageFinished()
    │  └─ تأخير 500ms
    │
3.5s├─ JavaScript Injection
    │  └─ ملء حقل Email
    │  └─ ملء حقل Password
    │
3.7s├─ الضغط على زر Login
    │
4.0s├─ ✅ دخول ناجح كامل
    │
    ▼

المجموع: ~4 ثواني من فتح التطبيق إلى الدخول الكامل! 🚀


╔═══════════════════════════════════════════════════════════════════════════════╗
║                          🎛️ حالات الخطأ والتعافي                             ║
╚═══════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────┐
│  خطأ: البصمة غير متاحة                                             │
├─────────────────────────────────────────────────────────────────────┤
│  السبب        │ الإجراء                       │ النتيجة           │
├───────────────┼───────────────────────────────┼────────────────────┤
│  البصمة غير   │ رسالة: "يرجى تفعيل البصمة"   │ إخفاء زر البصمة   │
│  مفعلة        │                               │ استخدام Log in    │
└───────────────┴───────────────────────────────┴────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│  خطأ: فشل التحقق من البصمة                                          │
├─────────────────────────────────────────────────────────────────────┤
│  السبب        │ الإجراء                       │ النتيجة           │
├───────────────┼───────────────────────────────┼────────────────────┤
│  بصمة خاطئة   │ 1. ملء الحقول تلقائياً        │ يمكن استخدام      │
│  أو إلغاء     │ 2. رسالة إرشادية              │ زر Log in          │
└───────────────┴───────────────────────────────┴────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│  خطأ: لا توجد بيانات محفوظة                                         │
├─────────────────────────────────────────────────────────────────────┤
│  السبب        │ الإجراء                       │ النتيجة           │
├───────────────┼───────────────────────────────┼────────────────────┤
│  أول مرة      │ رسالة: "يرجى تسجيل الدخول"   │ تعطيل البصمة      │
│  استخدام      │                               │ حتى الدخول أولاً  │
└───────────────┴───────────────────────────────┴────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│  خطأ: فشل حفظ البيانات                                              │
├─────────────────────────────────────────────────────────────────────┤
│  السبب        │ الإجراء                       │ النتيجة           │
├───────────────┼───────────────────────────────┼────────────────────┤
│  مشكلة Storage│ 1. حذف البيانات الجزئية       │ رسالة خطأ          │
│               │ 2. إعادة المحاولة             │ إعادة الدخول      │
└───────────────┴───────────────────────────────┴────────────────────┘
```

---

**نهاية الرسم التخطيطي** 🎉
